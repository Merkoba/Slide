(function(){"use strict";const d=typeof sampleRate<"u"?sampleRate:48e3,A=Math.PI/d,b=1/d;let E=i=>Math.pow(i,2);const V=(i,s,t)=>Math.min(Math.max(i,s),t);function c(i){return E(i)}function O(i,s,t){const e=Math.sin((1-t)*.5*Math.PI),h=Math.sin(t*.5*Math.PI);return i*e+s*h}class v{phase=0;update(s){const t=Math.sin(this.phase*2*Math.PI);return this.phase=(this.phase+s/d)%1,t}}class x{phase=0;update(s){return this.phase+=b*s,this.phase%1*2-1}}function y(i,s){return i<s?(i/=s,i+i-i*i-1):i>1-s?(i=(i-1)/s,i*i+i+i+1):0}class R{constructor(s={}){this.phase=s.phase??0}update(s){const t=s/d;let e=y(this.phase,t),h=2*this.phase-1-e;return this.phase+=t,this.phase>1&&(this.phase-=1),h}}function T(i,s,t){return i<2?0:((h,o,n)=>n*(o-h)+h)(-s*.5,s*.5,t/(i-1))}function z(i,s){return i*Math.pow(2,s/12)}class F{constructor(s={}){this.voices=s.voices??5,this.freqspread=s.freqspread??.2,this.panspread=s.panspread??.4,this.phase=new Float32Array(this.voices).map(()=>Math.random())}update(s){const t=Math.sqrt(1-this.panspread),e=Math.sqrt(this.panspread);let h=0,o=0;for(let n=0;n<this.voices;n++){const a=z(s,T(this.voices,this.freqspread,n))/d,p=(n&1)==1;let u=t;p&&(u=e);let q=y(this.phase[n],a),D=2*this.phase[n]-1-q;h=h+D*u,o=o+D*u,this.phase[n]+=a,this.phase[n]>1&&(this.phase[n]-=1)}return h+o}}class w{phase=0;update(s){this.phase+=b*s;let t=this.phase%1;return(t<.5?2*t:1-2*(t-.5))*2-1}}class g{s0=0;s1=0;update(s,t,e=0){e=Math.max(e,0),t=Math.min(t,2e4);let h=2*Math.sin(t*A);h=V(h,0,1.14);const n=1-Math.pow(.5,(e+.125)/.125)*h;return this.s0=n*this.s0-h*this.s1+h*s,this.s1=n*this.s1+h*this.s0,this.s1}}class I{constructor(s=0){this.phase=s}saw(s,t){let e=(this.phase+s)%1,h=y(e,t);return 2*e-1-h}update(s,t=.5){const e=s/d;let h=this.saw(0,e)-this.saw(t,e);return this.phase=(this.phase+e)%1,h+t*2-1}}class L{phase=0;update(s,t=.5){return this.phase+=b*s,this.phase%1<t?1:-1}}class S{update=s=>Math.random()<s*b?Math.random():0}class N{update(){return Math.random()*2-1}}class B{constructor(){this.out=0}update(){let s=Math.random()*2-1;return this.out=(this.out+.02*s)/1.02,this.out}}class G{constructor(){this.b0=0,this.b1=0,this.b2=0,this.b3=0,this.b4=0,this.b5=0,this.b6=0}update(){const s=Math.random()*2-1;this.b0=.99886*this.b0+s*.0555179,this.b1=.99332*this.b1+s*.0750759,this.b2=.969*this.b2+s*.153852,this.b3=.8665*this.b3+s*.3104856,this.b4=.55*this.b4+s*.5329522,this.b5=-.7616*this.b5-s*.016898;const t=this.b0+this.b1+this.b2+this.b3+this.b4+this.b5+this.b6+s*.5362;return this.b6=s*.115926,t*.11}}class j{phase=1;update(s){this.phase+=b*s;let t=this.phase>=1?1:0;return this.phase=this.phase%1,t}}function M(i,s,t,e=1){if(i<=0)return s;if(i>=1)return t;let h;return e===0?h=i:e>0?h=Math.pow(i,e):h=1-Math.pow(1-i,-e),s+(t-s)*h}class f{constructor(s={}){this.state="off",this.startTime=0,this.startVal=0,this.decayCurve=s.decayCurve??1}update(s,t,e,h,o,n){switch(this.state){case"off":return t>0&&(this.state="attack",this.startTime=s,this.startVal=0),0;case"attack":{let l=s-this.startTime;return l>e?(this.state="decay",this.startTime=s,1):M(l/e,this.startVal,1,1)}case"decay":{let l=s-this.startTime,a=M(l/h,1,o,-this.decayCurve);return t<=0?(this.state="release",this.startTime=s,this.startVal=a,a):l>h?(this.state="sustain",this.startTime=s,o):a}case"sustain":return t<=0&&(this.state="release",this.startTime=s,this.startVal=o),o;case"release":{let l=s-this.startTime;if(l>n)return this.state="off",0;let a=M(l/n,this.startVal,0,-this.decayCurve);return t>0&&(this.state="attack",this.startTime=s,this.startVal=a),a}}throw"invalid envelope state"}}const $=10;class k{writeIdx=0;readIdx=0;buffer=new Float32Array($*d);write(s,t){this.writeIdx=(this.writeIdx+1)%this.buffer.length,this.buffer[this.writeIdx]=s;let e=Math.min(Math.floor(d*t),this.buffer.length-1);this.readIdx=this.writeIdx-e,this.readIdx<0&&(this.readIdx+=this.buffer.length)}update(s,t){return this.write(s,t),this.buffer[this.readIdx]}}class W{delay=new k;modulator=new w;update(s,t,e,h,o){const n=this.modulator.update(h)*o,l=this.delay.update(s,e*(1+n));return O(s,l,t)}}class X{hold=0;t=0;update(s,t){return this.t++%t===0&&(this.t=0,this.hold=s),this.hold}}class U{update(s,t){t=Math.max(1,t);const e=Math.pow(2,t-1);return Math.round(s*e)/e}}class Y{update(s,t=0,e=1){e=Math.max(.001,Math.min(1,e));const h=Math.expm1(t);return(1+h)*s/(1+h*Math.abs(s))*e}}class _{static samples=new Map;buffer;sampleRate;pos=0;sampleFreq=P();constructor(s,t,e){this.buffer=s,this.sampleRate=t,this.duration=this.buffer.length/this.sampleRate,this.speed=d/this.sampleRate,e&&(this.speed*=this.duration)}update(s){if(this.pos>=this.buffer.length)return 0;const t=s/this.sampleFreq*this.speed;let e=this.buffer[Math.floor(this.pos)];return this.pos=this.pos+t,e}}const m=(i,s="linear",t)=>{const[n,l,a,p]=i;if(n==null&&l==null&&a==null&&p==null)return t??[.001,.001,1,.01];const u=a??(n!=null&&l==null||n==null&&l==null?1:.001);return[Math.max(n??0,.001),Math.max(l??0,.001),Math.min(u,1),Math.max(p??0,.01)]};let C={sine:v,saw:R,zaw:x,sawtooth:R,zawtooth:x,supersaw:F,tri:w,triangle:w,pulse:I,square:I,pulze:L,dust:S,crackle:S,impulse:j,white:N,brown:B,pink:G};const Z={chorus:0,note:48,s:"triangle",bank:"",gain:1,postgain:1,velocity:1,density:".03",ftype:"12db",fanchor:0,resonance:0,hresonance:0,bandq:0,channels:[1,2],phaserdepth:.75,shapevol:1,distortvol:1,delay:0,byteBeatExpression:"0",delayfeedback:.5,delayspeed:1,delaytime:.25,orbit:1,i:1,fft:8,z:"triangle",pan:.5,fmh:1,fmenv:0,speed:1,pw:.5};let r=i=>Z[i];const H={c:0,d:2,e:4,f:5,g:7,a:9,b:11},J={"#":1,b:-1,s:1,f:-1},K=(i,s=3)=>{let[t,e="",h=""]=String(i).match(/^([a-gA-G])([#bsf]*)([0-9]*)$/)?.slice(1)||[];if(!t)throw new Error('not a note: "'+i+'"');const o=H[t.toLowerCase()],n=e?.split("").reduce((a,p)=>a+J[p],0)||0;return(Number(h||s)+1)*12+o+n},Q=i=>Math.pow(2,(i-69)/12)*440,P=i=>(i=i||r("note"),typeof i=="string"&&(i=K(i,3)),Q(i));class tt{id=0;out=[0,0];attack;decay;sustain;release;_begin;_duration;_sound;_channels=1;_buffers;unit;_penv;penv;pattack;pdecay;psustain;prelease;vib;_vib;vibmod;_fm;fmh;fmi;_fmenv;fmattack;fmdecay;fmsustain;fmrelease;_lpenv;lpenv;lpattack;lpdecay;lpsustain;lprelease;_hpenv;hpenv;hpattack;hpdecay;hpsustain;hprelease;_bpenv;bpenv;bpattack;bpdecay;bpsustain;bprelease;cutoff;hcutoff;bandf;coarse;crush;distort;freq;note;_lpf;_hpf;_bpf;_chorus;_coarse;_crush;_distort;constructor(s){this.freq??=P(s.note),this._begin=s._begin,this._duration=s._duration,this.release=s.release??0;let t=this;if(Object.assign(t,s),t.s=t.s??r("s"),t.gain=c(t.gain??r("gain")),t.velocity=c(t.velocity??r("velocity")),t.postgain=c(t.postgain??r("postgain")),t.density=t.density??r("density"),t.fanchor=t.fanchor??r("fanchor"),t.drive=t.drive??.69,t.phaserdepth=t.phaserdepth??r("phaserdepth"),t.shapevol=c(t.shapevol??r("shapevol")),t.distortvol=c(t.distortvol??r("distortvol")),t.i=t.i??r("i"),t.chorus=t.chorus??r("chorus"),t.fft=t.fft??r("fft"),t.pan=t.pan??r("pan"),t.orbit=t.orbit??r("orbit"),t.fmenv=t.fmenv??r("fmenv"),t.resonance=t.resonance??r("resonance"),t.hresonance=t.hresonance??r("hresonance"),t.bandq=t.bandq??r("bandq"),t.speed=t.speed??r("speed"),t.pw=t.pw??r("pw"),[t.attack,t.decay,t.sustain,t.release]=m([t.attack,t.decay,t.sustain,t.release]),t._holdEnd=t._begin+t._duration,t._end=t._holdEnd+t.release+.01,t.fmi&&(t.s==="saw"||t.s==="sawtooth")&&(t.s="zaw"),C[t.s]){const e=C[t.s];t._sound=new e,t._channels=1}else if(_.samples.has(t.s)){const e=_.samples.get(t.s);t._buffers=[],t._channels=e.channels.length;for(let h=0;h<t._channels;h++)t._buffers.push(new _(e.channels[h],e.sampleRate,t.unit==="c"))}else console.warn("sound not loaded",t.s);t.penv&&(t._penv=new f({decayCurve:4}),[t.pattack,t.pdecay,t.psustain,t.prelease]=m([t.pattack,t.pdecay,t.psustain,t.prelease])),t.vib&&(t._vib=new v,t.vibmod=t.vibmod??r("vibmod")),t.fmi&&(t._fm=new v,t.fmh=t.fmh??r("fmh"),t.fmenv&&(t._fmenv=new f({decayCurve:2}),[t.fmattack,t.fmdecay,t.fmsustain,t.fmrelease]=m([t.fmattack,t.fmdecay,t.fmsustain,t.fmrelease]))),t._adsr=new f({decayCurve:2}),t.delay=c(t.delay??r("delay")),t.delayfeedback=t.delayfeedback??r("delayfeedback"),t.delayspeed=t.delayspeed??r("delayspeed"),t.delaytime=t.delaytime??r("delaytime"),t.lpenv&&(t._lpenv=new f({decayCurve:4}),[t.lpattack,t.lpdecay,t.lpsustain,t.lprelease]=m([t.lpattack,t.lpdecay,t.lpsustain,t.lprelease])),t.hpenv&&(t._hpenv=new f({decayCurve:4}),[t.hpattack,t.hpdecay,t.hpsustain,t.hprelease]=m([t.hpattack,t.hpdecay,t.hpsustain,t.hprelease])),t.bpenv&&(t._bpenv=new f({decayCurve:4}),[t.bpattack,t.bpdecay,t.bpsustain,t.bprelease]=m([t.bpattack,t.bpdecay,t.bpsustain,t.bprelease])),t._chorus=t.chorus?[]:null,t._lpf=t.cutoff?[]:null,t._hpf=t.hcutoff?[]:null,t._bpf=t.bandf?[]:null,t._coarse=t.coarse?[]:null,t._crush=t.crush?[]:null,t._distort=t.distort?[]:null;for(let e=0;e<this._channels;e++)t._lpf?.push(new g),t._hpf?.push(new g),t._bpf?.push(new g),t._chorus?.push(new W),t._coarse?.push(new X),t._crush?.push(new U),t._distort?.push(new Y)}update(s){if(!this._sound&&!this._buffers)return 0;let t=+(s>=this._begin&&s<=this._holdEnd),e=this.freq*this.speed;if(this._fm&&this.fmh!==void 0&&this.fmi!==void 0){let a=this.fmi;if(this._fmenv){const q=this._fmenv.update(s,t,this.fmattack,this.fmdecay,this.fmsustain,this.fmrelease);a=this.fmenv*q*a}const p=e*this.fmh,u=p*a;e=e+this._fm.update(p)*u}if(this._vib&&this.vibmod!==void 0&&(e=e*2**(this._vib.update(this.vib)*this.vibmod/12)),this._penv&&this.penv!==void 0){const a=this._penv.update(s,t,this.pattack,this.pdecay,this.psustain,this.prelease);e=e+a*this.penv}let h=this.cutoff;if(h!==void 0&&this._lpenv){const a=this._lpenv.update(s,t,this.lpattack,this.lpdecay,this.lpsustain,this.lprelease);h=this.lpenv*a*h+h}let o=this.hcutoff;if(o!==void 0&&this._hpenv&&this.hpenv!==void 0){const a=this._hpenv.update(s,t,this.hpattack,this.hpdecay,this.hpsustain,this.hprelease);o=2**this.hpenv*a*o+o}let n=this.bandf;if(n!==void 0&&this._bpenv&&this.bpenv!==void 0){const a=this._bpenv.update(s,t,this.bpattack,this.bpdecay,this.bpsustain,this.bprelease);n=2**this.bpenv*a*n+n}const l=this._adsr.update(s,t,this.attack,this.decay,this.sustain,this.release);for(let a=0;a<this._channels;a++){if(this._sound&&this.s==="pulse"?this.out[a]=this._sound.update(e,this.pw):this._sound?this.out[a]=this._sound.update(e):this._buffers&&(this.out[a]=this._buffers[a].update(e)),this.out[a]=this.out[a]*this.gain*this.velocity,this._chorus){const p=this._chorus[a].update(this.out[a],this.chorus,.03+.05*a,1,.11);this.out[a]=p+this.out[a]}this._lpf&&(this._lpf[a].update(this.out[a],h,this.resonance),this.out[a]=this._lpf[a].s1),this._hpf&&(this._hpf[a].update(this.out[a],o,this.hresonance),this.out[a]=this.out[a]-this._hpf[a].s1),this._bpf&&(this._bpf[a].update(this.out[a],n,this.bandq),this.out[a]=this._bpf[a].s0),this._coarse&&(this.out[a]=this._coarse[a].update(this.out[a],this.coarse)),this._crush&&(this.out[a]=this._crush[a].update(this.out[a],this.crush)),this._distort&&(this.out[a]=this._distort[a].update(this.out[a],this.distort,this.distortvol)),this.out[a]=this.out[a]*l,this.out[a]=this.out[a]*this.postgain,this._buffers||(this.out[a]=this.out[a]*.2)}if(this._channels===1&&(this.out[1]=this.out[0]),this.pan!==.5){const a=this.pan*Math.PI/2;this.out[0]=this.out[0]*Math.cos(a),this.out[1]=this.out[1]*Math.sin(a)}}}class st{voices=[];vid=0;q=[];out=[0,0];delaysend=[0,0];delaytime=r("delaytime");delayfeedback=r("delayfeedback");delayspeed=r("delayspeed");t=0;constructor(s=48e3,t=0){this.sampleRate=s,this.t=Math.floor(t*s),this._delayL=new k,this._delayR=new k}loadSample(s,t,e){_.samples.set(s,{channels:t,sampleRate:e})}scheduleSpawn(s){if(s._begin===void 0)throw new Error("[dough]: scheduleSpawn expected _begin to be set");if(s._duration===void 0)throw new Error("[dough]: scheduleSpawn expected _duration to be set");s.sampleRate=this.sampleRate;const t=Math.floor(s._begin*this.sampleRate);this.schedule({time:t,type:"spawn",arg:s})}spawn(s){s.id=this.vid++;const t=new tt(s);this.voices.push(t);const e=Math.ceil(t._end*this.sampleRate);this.schedule({time:e,type:"despawn",arg:t.id})}despawn(s){this.voices=this.voices.filter(t=>t.id!==s)}schedule(s){if(!this.q.length){this.q.push(s);return}let t=0;for(;t<this.q.length&&this.q[t].time<s.time;)t++;this.q.splice(t,0,s)}update(){for(;this.q.length>0&&this.q[0].time<=this.t;)this[this.q[0].type](this.q[0].arg),this.q.shift();this.out[0]=0,this.out[1]=0;for(let e=0;e<this.voices.length;e++)this.voices[e].update(this.t/this.sampleRate),this.out[0]+=this.voices[e].out[0],this.out[1]+=this.voices[e].out[1],this.voices[e].delay&&(this.delaysend[0]+=this.voices[e].out[0]*this.voices[e].delay,this.delaysend[1]+=this.voices[e].out[1]*this.voices[e].delay,this.delaytime=this.voices[e].delaytime,this.delayspeed=this.voices[e].delayspeed,this.delayfeedback=this.voices[e].delayfeedback);const s=this._delayL.update(this.delaysend[0],this.delaytime),t=this._delayR.update(this.delaysend[1],this.delaytime);this.delaysend[0]=s*this.delayfeedback,this.delaysend[1]=t*this.delayfeedback,this.out[0]+=s,this.out[1]+=t,this.t++}}const et=(i,s,t)=>Math.min(Math.max(i,s),t);class it extends AudioWorkletProcessor{constructor(){super(),this.dough=new st(sampleRate,currentTime),this.port.onmessage=s=>{s.data.spawn?this.dough.scheduleSpawn(s.data.spawn):s.data.sample?this.dough.loadSample(s.data.sample,s.data.channels,s.data.sampleRate):s.data.samples?s.data.samples.forEach(([t,e,h])=>{this.dough.loadSample(t,e,h)}):console.log("unrecognized event type",s.data)}}process(s,t,e){if(this.disconnected)return!1;const h=t[0];for(let o=0;o<h[0].length;o++){this.dough.update();for(let n=0;n<h.length;n++)h[n][o]=et(this.dough.out[n],-1,1)}return!0}}registerProcessor("dough-processor",it)})();
